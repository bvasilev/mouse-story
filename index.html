<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
    <script src="levels.js"></script>
    <script src="model.js"></script>
</head>
<body>

    <script>

    var model = new Model();

    model.readLevelFromFile(5)

    //var level=[[".",".","."],["#",".","."],["#",".","."]]
    var actors=[]

    var squaresize=100

    var gridX=model.cntCols//model.cntCols//level[0].length
    var gridY=model.cntRows//model.cntRows//level.length

    var width = window.innerWidth-20
    var height = window.innerHeight-20

    var x=height/(1200*gridY);
    var y=width/(1200*gridX);
    if(y<x) x=y

    var config = {
        type: Phaser.AUTO,
        width: width,
        height: height,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: {  },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: display_model,
            update: update
        }
    };

    var game = new Phaser.Game(config);

    function preload ()
    {
    
        this.load.image('Normal Mouse', 'assets/img/mouse.png');
        this.load.image('Free Tile', 'assets/img/panel.png');
        this.load.image('Obstacle Tile', 'assets/img/obstacle.png');
        this.load.image('Cheese', 'assets/img/cheese.png');
        this.load.image('Blue Mouse', 'assets/img/blue-mouse.png');
        this.load.image('Blue Cheese', 'assets/img/blue-cheese.png');
        this.load.image('House', 'assets/img/house.png');
        this.load.image('Blue House', 'assets/img/blue-house.png');
    }

    function display_model ()
    {
        squaresize=800*x


        for (var i = gridX-1; i >= 0; i--) {
            for (var j = gridY-1; j >= 0; j--) {
                var squareType = model.queryTile(gridY-j-1,gridX-i-1).phaserTextureAlias
                var panel = this.add.image(0, 0, squareType).setScale(x,x).setOrigin(i-gridX+1,1+j-gridY-(height-200)/800);
            }   
        }
        var i=0
        for(var a of model.actors){
            var actor=this.physics.add.sprite(0,0,a.name).setScale(x,x).setOrigin(-a.position.col,-(height-200)/800-a.position.row);
            actor.displayHeight=x*800;
            actor.displayWidth=x*800;
            actors[i]=new Actor(actor,-a.position.row,-(height-200)/800-a.position.col,a.name)
            i+=1
        }
    }
    updating=true
    var upd_cnt = 0;
    function update()
    {
        if(updating){
            updating=false
            model.runStep();
            var i=0
            for(var a of actors){
                try{
                    var mactor=model.getByName(a.name)
                    if(a.x>-mactor.position.row){
                        a.actor.setVelocityY(800*x);
                    }
                    else if(a.x<-mactor.position.row){
                        a.actor.setVelocityY(-800*x);
                    } 
                    else if(a.y>-(height-200)/800-mactor.position.col){
                        a.actor.setVelocityX(800*x);
                    }  
                    else if(a.y<-(height-200)/800-mactor.position.col){
                        a.actor.setVelocityX(-800*x);
                    }
                }catch(err){
                }
            }
            setTimeout(function(){
                updating=true;
                for(var a of actors){
                    if(!a.destroyed){
                        try{
                            var mactor=model.getByName(a.name)
                            a.actor.setOrigin(-mactor.position.col,-(height-200)/800-mactor.position.row);
                            a.actor.x=0
                            a.actor.y=0
                            a.actor.setVelocityX(0)
                            a.actor.setVelocityY(0)
                            a.x=-mactor.position.row
                            a.y=-(height-200)/800-mactor.position.col
                        }catch(err){
                            a.actor.destroy()
                            a.destroyed=true
                        }
                    }
                }
            },1000);
            
            
        }
        //do{
            //display_model()
        //} while(model.runStep())
    }

    class Actor {
        constructor(a,x,y,n) {
            this.actor = a;
            this.x = x;
            this.y = y;
            this.name=n
            this.destroyed=false
        }

    }
    </script>

</body>
</html>